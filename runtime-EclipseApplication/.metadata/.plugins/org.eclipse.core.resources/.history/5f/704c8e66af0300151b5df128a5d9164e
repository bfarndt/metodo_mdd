<?php

include_once "Bruno.class.php";
include_once "Daniel.class.php";

class BrunoDB
{
	private $dbconn;
	private $host = "localhost";
	private $port = "5432";
	private $dbname = "jet";
	private $user = "postgres";
	private $password = "teste";
	
	public function __construct()
	{
		$this->dbconn = pg_connect("host= " . $this->host . " port=" . $this->port . " dbname=" . $this->dbname . " user=" . $this->user . " password=" . $this->password);
	}
	
	public function add($Bruno)
	{
		$query = pg_query("INSERT INTO bruno(cpf, endereco, nascimento, mensalidade, orientador) VALUES('" . $Bruno->getCpf() . "', '" . $Bruno->getEndereco() . "', '" . $Bruno->getNascimento() . "', '" . $Bruno->getMensalidade() . "', '" . $Bruno->getOrientador() . "')");
		
		return (pg_affected_rows($query) > 0);
	}
	
	public function update($Bruno)
	{
		$query = pg_query("UPDATE bruno SET
				cpf = '" . $Bruno->getCpf() . "', 
				endereco = '" . $Bruno->getEndereco() . "', 
				nascimento = '" . $Bruno->getNascimento() . "', 
				mensalidade = '" . $Bruno->getMensalidade() . "', 
				orientador = '" . $Bruno->getOrientador() . "'
			WHERE id = " . $Bruno->getId());
		
		return (pg_affected_rows($query) > 0);
	}
	
	public function destroy($Bruno)
	{
		$query = pg_query("DELETE FROM bruno WHERE id = " . $Bruno->getId());
		
		return (pg_affected_rows($query) > 0);
	}
	
	public function getAll()
	{
		$result = array();
		
		$query = pg_query("SELECT
			bruno.id AS bruno_id,
			bruno.cpf AS bruno_cpf, bruno.endereco AS bruno_endereco, bruno.nascimento AS bruno_nascimento, bruno.mensalidade AS bruno_mensalidade, 
				daniel.id AS daniel_id,daniel.cpf AS daniel_cpf, daniel.endereco AS daniel_endereco
			
			FROM bruno
			INNER JOIN daniel ON daniel.id = bruno.orientador
		");
		
		if ($query) {
			while ($row = pg_fetch_assoc($query)) {
				$Bruno = new Bruno();

				$Bruno->setId($row["id"]);
			
				$Bruno->setCpf($row["cpf"]);
			
				$Bruno->setEndereco($row["endereco"]);
			
				$Bruno->setNascimento($row["nascimento"]);
			
				$Bruno->setMensalidade($row["mensalidade"]);
			
				$Daniel = new Daniel();
				$Daniel->setId($row["id"]);
				$Daniel->setCpf($row["cpf"]);
				$Daniel->setEndereco($row["endereco"]);
				
				$Bruno->setOrientador($Daniel);
			
				$result[] = $Bruno;
			}
		}
		
		return $result;
	}
	
	public function get($Bruno)
	{
		$result = array();
		
		$where = "";
		
	
		if (strlen($Bruno->getCpf()) > 0) {
			if (strlen($where) > 0) {
				$where .= " AND ";
			} else {
				$where = "WHERE ";
			}
			
			$where .= "bruno.cpf = '" . $Bruno->getCpf() . "'";
			
		}
	
		if (strlen($Bruno->getEndereco()) > 0) {
			if (strlen($where) > 0) {
				$where .= " AND ";
			} else {
				$where = "WHERE ";
			}
			
			$where .= "bruno.endereco = '" . $Bruno->getEndereco() . "'";
			
		}
	
		if (strlen($Bruno->getNascimento()) > 0) {
			if (strlen($where) > 0) {
				$where .= " AND ";
			} else {
				$where = "WHERE ";
			}
			
			$where .= "bruno.nascimento = '" . $Bruno->getNascimento() . "'";
			
		}
	
		if (strlen($Bruno->getMensalidade()) > 0) {
			if (strlen($where) > 0) {
				$where .= " AND ";
			} else {
				$where = "WHERE ";
			}
			
			$where .= "bruno.mensalidade = '" . $Bruno->getMensalidade() . "'";
			
		}
	
		if (strlen($Bruno->getOrientador()) > 0) {
			if (strlen($where) > 0) {
				$where .= " AND ";
			} else {
				$where = "WHERE ";
			}
			
			$where .= "bruno.orientador = " . $Bruno->getOrientador()->getId();
			
		}
	
		$query = pg_query("SELECT
			bruno.id AS bruno_id,bruno.cpf AS bruno_cpf, bruno.endereco AS bruno_endereco, bruno.nascimento AS bruno_nascimento, bruno.mensalidade AS bruno_mensalidade, 
				daniel.id AS daniel_id,daniel.cpf AS daniel_cpf, daniel.endereco AS daniel_endereco
			
			FROM bruno
			INNER JOIN daniel ON daniel.id = bruno.orientador
		" . $where);
		
		if ($query) {
			while ($row = pg_fetch_assoc($query)) {
				$Bruno = new Bruno();

				$Bruno->setId($row["id"]);
			
				$Bruno->setCpf($row["cpf"]);
			
				$Bruno->setEndereco($row["endereco"]);
			
				$Bruno->setNascimento($row["nascimento"]);
			
				$Bruno->setMensalidade($row["mensalidade"]);
			
				$Daniel = new Daniel();
				$Daniel->setId($row["id"]);
				$Daniel->setCpf($row["cpf"]);
				$Daniel->setEndereco($row["endereco"]);
				
				$Bruno->setOrientador($Daniel);
			
				$result[] = $Bruno;
			}
		}
		
		return $result;
	}
}

?>